param([string]$TargetSubscriptionName = "DriversHealth", [string]$BackendHostname = "drivershealth.azurewebsites.net", [string]$AlertEmail = "devops@drivershealth.com")
Write-Host "AZURE FRONT DOOR DEPLOYMENT" -ForegroundColor Green

# Check prerequisites
if (-not (Get-Command az -ErrorAction SilentlyContinue)) { 
    Write-Host "ERROR: Azure CLI not installed" -ForegroundColor Red
    Write-Host "Install from: https://aka.ms/installazurecliwindows"
    exit 1 
}
if (-not (Get-Command terraform -ErrorAction SilentlyContinue)) { 
    Write-Host "ERROR: Terraform not installed" -ForegroundColor Red
    Write-Host "Install from: https://www.terraform.io/downloads"
    exit 1 
}

# Azure login with device code (works on restricted networks)
Write-Host "Checking Azure authentication..."
$account = az account show 2>$null
if (-not $account) { 
    Write-Host "Opening browser for login..." -ForegroundColor Yellow
    az login --use-device-code
}
Write-Host "Authenticated!" -ForegroundColor Green
Write-Host ""

# Get subscriptions
$subs = az account list | ConvertFrom-Json
Write-Host "SUBSCRIPTIONS:"
for ($i = 0; $i -lt $subs.Count; $i++) { 
    Write-Host "$($i + 1). $($subs[$i].name) - ID: $($subs[$i].id) - Tenant: $($subs[$i].tenantId)" 
}

# Find or select subscription
$targetSub = $subs | Where-Object { $_.name -like "*$TargetSubscriptionName*" } | Select-Object -First 1
if ($targetSub) { 
    Write-Host "Found: $($targetSub.name)" -ForegroundColor Green 
} else { 
    Write-Host "DriversHealth not found" -ForegroundColor Yellow
    Write-Host "Options: 1) Select existing subscription  2) Create new DriversHealth subscription"
    $option = Read-Host "Choose option (1 or 2)"
    if ($option -eq "2") { 
        Write-Host "Creating DriversHealth subscription..." -ForegroundColor Yellow
        Write-Host "Note: Subscription creation requires billing account access"
        Write-Host "Use Azure Portal: https://portal.azure.com/#create/Microsoft.Subscription"
        Write-Host "Or contact your Azure admin to create the subscription"
        Write-Host "After creation, run this script again"
        exit 0 
    } else { 
        $choice = Read-Host "Enter subscription number (1-$($subs.Count))"
        $targetSub = $subs[[int]$choice - 1] 
    } 
}

az account set --subscription $targetSub.id
Write-Host "Using: $($targetSub.name)" -ForegroundColor Green

@"
project_name        = "DriversHealth"
environment         = "prod"
location            = "East US"
backend_host_name   = "$BackendHostname"
health_probe_path   = "/"
alert_email_address = "$AlertEmail"
"@ | Out-File terraform.tfvars -Encoding UTF8 -Force

Write-Host "Initializing Terraform..." -ForegroundColor Yellow
terraform init -upgrade
Write-Host "Validating..." -ForegroundColor Yellow
terraform validate
Write-Host "Deploying..." -ForegroundColor Yellow
terraform apply -auto-approve
if ($LASTEXITCODE -eq 0) { 
    $fdUrl = terraform output -raw frontdoor_url 2>$null
    Write-Host "SUCCESS! Front Door: $fdUrl" -ForegroundColor Green 
}



$account = az account show 2>$null
if (-not $account) { 
    Write-Host "Logging in to Azure with device code..." -ForegroundColor Yellow
    az login --use-device-code
}